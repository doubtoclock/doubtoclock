{% extends "base.html" %}

{% block gradient %}linear-gradient(to bottom, #e08bb7, #5c2e86);{% endblock gradient %}

{% block styles %}
    .page-title { font-size: 40px; font-weight: bold; margin: 40px 0 20px 0; }
    .ask-box { flex:1; max-width:500px; background:#d3d3d3; padding:15px 20px; border-radius:30px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:black; box-shadow:0 4px 6px rgba(0,0,0,0.2); cursor:pointer; }
    #addImageBtn { background:#fff; color:black; padding:10px 20px; border-radius:25px; display:flex; align-items:center; gap:8px; font-size:14px; font-weight:bold; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.3); }
    .recent { text-align:left; margin:40px auto; width:90%; max-width:700px; }
    .recent h2 { font-size:18px; margin-bottom:20px; }
    .question-card { background: rgba(255,255,255,0.2); padding:20px; border-radius:15px; margin-bottom:20px; font-size:16px; color:white; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
    #chatBox { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border:2px solid #ddd; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); padding:20px; width:400px; z-index:1000; }
    .search-box { background:rgba(0, 0, 0, 0.7); padding:12px 20px; border-radius:25px; width:250px; margin:20px auto; color:white; font-weight:bold; cursor:pointer; text-align:center; transition: transform 0.1s ease-in; }
    .search-box:hover { transform: scale(1.05); }
    .buttons { display:flex; justify-content:center; align-items:center; gap:15px; margin:20px auto; }
    @media (max-width:480px){ .buttons { flex-direction:column; gap:10px; } }
{% endblock styles %}

{% block body %}
  <div class="page-title">JEE/NEET</div>

  <div class="buttons">
    <div class="search-box" onclick="openChatBox()">Ask your doubt</div>
    <button id="addImageBtn">Add Image</button>
  </div>

  <!-- Hidden Chatbox -->
  <div id="chatBox" style="display:none;">
    <h4>Ask Your Doubt</h4>
    <form method="POST" action="{% url 'ask_doubt_jn' %}">
      {% csrf_token %}
      <textarea name="text" rows="4" placeholder="Type your doubt here..." style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;"></textarea>
      <br><br>
      <button type="submit" style="background-color:#4CAF50; color:white; border:none; padding:8px 12px; border-radius:5px;">Submit</button>
      <button type="button" onclick="closeChatBox()" style="background-color:#f44336; color:white; border:none; padding:8px 12px; border-radius:5px;">Close</button>
    </form>
  </div>

  <!-- Hidden file input form -->
  <form id="imageUploadForm" method="POST" enctype="multipart/form-data" style="display:none;">
      {% csrf_token %}
      <input type="file" name="image" id="hiddenFileInput" accept="image/*">
      <input type="text" name="title" value="User Image">
  </form>

  <div class="recent">
    <h2>RECENTLY ASKED DOUBTS</h2>
    {% for doubt in doubts %}
        <div class="question-card">
            <strong>{{ doubt.user.username }}</strong>: {{ doubt.text }}
        </div>
    {% empty %}
        <p>No doubts asked yet.</p>
    {% endfor %}
  </div>

  <script>
    // -------------------
    // Chatbox functions
    // -------------------
    function openChatBox(){ document.getElementById("chatBox").style.display="block"; }
    function closeChatBox(){ document.getElementById("chatBox").style.display="none"; }

    // -------------------
    // Image Upload Logic
    // -------------------
    const addImageBtn = document.getElementById("addImageBtn");
    const hiddenInput = document.getElementById("hiddenFileInput");
    const imageForm = document.getElementById("imageUploadForm");

    addImageBtn.addEventListener("click", () => hiddenInput.click());

    hiddenInput.addEventListener("change", () => {
        if (hiddenInput.files.length > 0) {
            const formData = new FormData(imageForm);

            fetch("{% url 'upload_image' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    alert("✅ Image uploaded successfully!");
                    hiddenInput.value = "";  // reset input
                } else {
                    alert("⚠️ Upload failed: " + (data.error || "Unknown error"));
                }
            })
            .catch((error) => {
                console.error(error);
                alert("❌ Upload failed!");
            });
        }
    });

    // -------------------
    // CSRF Helper Function
    // -------------------
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
  </script>
{% endblock body %}
